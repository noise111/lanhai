{template 'default2/header'}
<style>
    .weui-panel {
        margin-top: 0;
    }

    .weui-panel:before {
        border-top: 0;
    }

    .weui-media-box_appmsg .weui-media-box__thumb {
        border-radius: 50%;
    }

    .weui-media-box__title {
        font-size: 0.75rem;
        color: #686868;
    }

    .weui-media-box__desc {
        color: #d2d2d2;
    }

    .weui-media-box__desc .fr {
        margin-top: 0.2rem;
    }

    .weui-panel__ft {
        padding: 0px 15px 10px;
        font-size: 14px;
    }

    .weui-tabbar {
        background-color: transparent;
        z-index: 1;
    }

    .active-btn span {
        font-size: 15px;
    }

    .weui-popup__container--visible .weui-popup__modal {
        background: #ffffff;
    }

    .weui-cells:before {
        border-top: none;
    }

    .weui-cells:after {
        border-bottom: none;
    }

    .weui-cell:before {
        border-top: none;
    }

    .weui-check__label:before {
        content: " ";
        position: absolute;
        left: 0;
        right: 0;
        height: 1px;
        color: #d9d9d9;
        top: 0;
        border-top: 1px solid #d9d9d9;
        -webkit-transform-origin: 0 0;
        transform-origin: 0 0;
        -webkit-transform: scaleY(.5);
        transform: scaleY(.5);
    }

    .weui-cells_checkbox .weui-check:checked + .weui-icon-checked:before {
        color: #FA7E0A;
    }

    .weui-cell__bd {
        font-size: 0.65rem;
    }

    .weui-cell__bd p {
        margin-top: 4px;
    }
</style>

<body>
<div style="margin-bottom: 50px" id="list">


</div>

<div class="weui-tabbar">
    <a class="active-btn open-popup" href="javascript:;" data-target="#full">
        <img src="{MODULE_URL}template/mobile/default2/static/images/icon/icon-apply.png"> <span>评价</span>
    </a>
</div>
<div id="full" class='weui-popup__container'>
    <div class="weui-popup__overlay"></div>
    <div class="weui-popup__modal">
        <div class="group-evaluation">
            <div class="weui-cells  weui-cells_checkbox">
                <div class="weui-cell group-evaluation-bg">
                    <div class="weui-cell__bd">
                        <textarea class="weui-textarea" placeholder="请输入文本" rows="3" id="content"></textarea>
                    </div>
                </div>
                <div class="group-line"></div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <div class="weui-uploader">
                            <div class="weui-uploader__bd">
                                <ul class="weui-uploader__files" id="uploaderFiles">
                                    <!--<li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>-->
                                    <!--<li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>-->
                                    <!--<li class="weui-uploader__file" style="background-image:url(./images/pic_160.png)"></li>-->
                                </ul>
                                <div class="weui-uploader__input-box" id="addPic">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <label class="weui-cell weui-check__label" for="s11">
                    <div class="weui-cell__hd">
                        <input type="checkbox" class="weui-check" name="status" id="s11">
                        <i class="weui-icon-checked"></i>
                    </div>
                    <div class="weui-cell__bd">
                        <p>匿名评价</p>
                    </div>
                </label>
            </div>
            <div class="group-line"></div>
            <div class="weui-cells-group">
                <section class="main">
                    <div class="main-wrap">
                        <span class="revtit">综合评分:</span>
                        <div id="mydiv1" currentindex="1" class="mydiv">
                            <input type="hidden" id="rank"/>
                            <ul class="star_ul">
                                <li num="1"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>
                                <li num="2"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>
                                <li num="3"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>
                                <li num="4"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>
                                <li num="5"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>
                            </ul>
                        </div>
                    </div>
                    <!--<div class="main-wrap">-->
                        <!--<span class="revtit">基本素质:</span>-->
                        <!--<div id="mydiv2" currentindex="0" class="mydiv">-->
                            <!--<ul class="star_ul">-->
                                <!--<li num="1"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>-->
                                <!--<li num="2"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>-->
                                <!--<li num="3"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>-->
                                <!--<li num="4"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>-->
                                <!--<li num="5"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>-->
                            <!--</ul>-->
                        <!--</div>-->
                    <!--</div>-->
                    <!--<div class="main-wrap">-->
                        <!--<span class="revtit">仪容着装:</span>-->
                        <!--<div id="mydiv3" currentindex="0" class="mydiv">-->
                            <!--<ul class="star_ul">-->
                                <!--<li num="1"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>-->
                                <!--<li num="2"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>-->
                                <!--<li num="3"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>-->
                                <!--<li num="4"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>-->
                                <!--<li num="5"><img src="{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png" class="xing_hui"></li>-->
                            <!--</ul>-->
                        <!--</div>-->
                    <!--</div>-->
                </section>
            </div>
        </div>
        <div class="address_form_ft" style="margin-top: 50px" id="submit">
            <a href="javascript:;" class="weui-btn register-guide-btn close-popup">提交</a>
        </div>
        <!--<a href="javascript:;" class="weui-btn weui-btn_primary ">关闭</a>-->
    </div>
</div>
<script type="text/html" id="xq_list">
    {{# for(var i = 0, len = d.list.length; i < len; i++){ }}
    <div class="weui-panel">
        <div class="weui-panel__bd">
            <a href="javascript:void(0);" class="weui-media-box weui-media-box_appmsg">
                <div class="weui-media-box__hd">
                    <img class="weui-media-box__thumb" src="{{d.list[i].avatar}}" alt="">
                </div>
                <div class="weui-media-box__bd">
                    <h4 class="weui-media-box__title">{{d.list[i].realname}}</h4>
                    <p class="weui-media-box__desc">
                        {{# for(var j = 0, le = 5; j < le; j++){ }}
                        <i class="iconfont" {{# if(j < d.list[i].rank ){ }}style="color: #FA7E0A"{{# } }}>&#xe60f</i>
                        {{# } }}
                        <span class="fr">{{d.list[i].createtime}}</span>
                    </p>
                </div>
            </a>
        </div>
        <div class="weui-panel__ft">
            <p>{{d.list[i].content}}</p>
            <div class="weui-uploader">
                <div class="weui-uploader__bd">
                    <ul class="weui-uploader__files" >
                        {{# if(d.logimages){ }}
                        {{# if(d.logimages.length >0 ){ }}
                        {{# for(var i = 0, len = d.logimages.length; i < len; i++){ }}
                        <li class="weui-uploader__file"
                            style="background-image:url({{ d.logimages[i] }})"></li>
                        {{# } }}
                        {{# } }}
                        {{# } }}
                    </ul>

                </div>
            </div>
        </div>
    </div>
    {{# } }}
</script>
<script src="{MODULE_URL}template/mobile/default2/static/js/fastclick.js"></script>
<script src="{MODULE_URL}template/mobile/default2/static/js/common.js"></script>
<script src="{MODULE_URL}template/mobile/default2/static/js/jquery-weui.js"></script>
<script src="{MODULE_URL}template/mobile/default2/static/js/list.js"></script>
<script>
    var dpid = "{$_GPC['dpid']}";
    $(function () {
        var url = "{php echo wxapp_url('business/display')}&dpid="+dpid;
        loaddata(url, $("#list"), 'xq_list', true);
    })
</script>
<script>
    // jssdk config 对象
    jssdkconfig = {php echo json_encode($_W['account']['jssdkconfig']);} ||{};
    // 是否启用调试
    jssdkconfig.debug = false;
    jssdkconfig.jsApiList = [
        'openLocation',
        'getLocation',
        'chooseImage',
        'uploadImage',
    ];
    $(function () {
        wx.config(jssdkconfig);
        wx.ready(function () {
            $("#addPic").click(function () {
                wx.chooseImage({
                    count: 9, // 默认9
                    sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                    sourceType:  ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                    success: function (res) {
                        var localId = res.localIds[0];
                        wx.uploadImage({
                            localId: localId, // 需要上传的图片的本地ID，由chooseImage接口获得
                            isShowProgressTips: 1, // 默认为1，显示进度提示
                            success: function (res) {
                                var serverId = res.serverId; // 返回图片的服务器端ID
                                // var content = '<div class="pic"> <img class="" src="' + localId + '" style="display: none;"><input type="hidden" id="pic_"' + localId + ' name="pic[]" value="'+serverId+'"></div>'
                                var content = '<li class="weui-uploader__file" style="background-image:url('+localId+')"></li><input type="hidden" id="pic_"' + localId + ' name="pic[]" value="'+serverId+'">'
                                $("#uploaderFiles").append(content);
                            }
                        });
                    }
                });
            });
        });
    })
</script>
<script>

    $(document).on("open", ".weui-popup-modal", function () {
        console.log("open popup");
    }).on("close", ".weui-popup-modal", function () {
        console.log("close popup");
    });


    var isclick = false;
    function change(mydivid, num) {
        if (!isclick) {
            var tds = $("#" + mydivid + " ul li");
            for (var i = 0; i < num; i++) {
                var td = tds[i];
                $(td).find("img").attr("src", "{MODULE_URL}template/mobile/default2/static/images/icon/star_full.png");
            }
            var tindex = $("#" + mydivid).attr("currentIndex");
            tindex = tindex == 0 ? 0 : tindex + 1;
            for (var j = num; j < tindex; j++) {
                var td = tds[j];
                $(td).find("img").attr("src", "{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png");
            }
            $("#" + mydivid).attr("currentIndex", num);
        }
    }
    function repeal(mydivid, num) {
        if (!isclick) {
            var tds = $("#" + mydivid + " ul li");
            var tindex = $("#" + mydivid).attr("currentIndex");
            tindex = tindex == 0 ? 0 : tindex + 1;
            for (var i = tindex; i < num; i++) {
                var td = tds[i];
                $(td).find("img").attr("src", "{MODULE_URL}template/mobile/default2/static/images/icon/star_empty.png");
            }
            $("#" + mydivid).attr("currentIndex", num);
        }
    }
    function change1(mydivid, num) {
        if (!isclick) {
            change(mydivid, num);
        }
        else {
            alert("Sorry,You had clicked me!");
        }
    }
    $(function () {
        initEvent('mydiv1');
        initEvent('mydiv2');
        initEvent('mydiv3');
    });
    function initEvent(mydivid) {
        var tds = $("#" + mydivid + " ul li");
        for (var i = 0; i < tds.length; i++) {
            var td = tds[i];
            $(td).on('mouseover', function () {
                var num = $(this).attr("num");
                change(mydivid, num);
                $("#rank").val(num);
            });
            $(td).on('click', function () {
                var num = $(this).attr("num");
                change1(mydivid, num);
                $("#rank").val(num);
            });
        }
    }
    $(function () {
        $("#submit").click(function () {

            var status = $('input[name="status"]:checked').val();
            var rank = $("#rank").val();
            var content = $("#content").val();
            var url = "{php echo wxapp_url('business/rank')}";
            var pics ='';
            $('input[name="pic[]"]').each(function(){
                var t1 = $(this).val();
                pics += t1+',';
            });
            $.getJSON(url,{rankid:dpid,status:status,rank:rank,content:content,pics:pics},function (data) {
                if(data.err_code ==0){
                    //提交成功提示内容: data.data.content
                    $.toast(data.data.content, "text");
                    setTimeout(function () {
                        //定时刷新
                        window.location.reload();
                    }, 1500);

                }
            })
        })
    })
</script>
</body>
</html>